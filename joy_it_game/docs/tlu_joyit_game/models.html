<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>models.py</title>
  <link rel="stylesheet" href="../pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>models.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>module: models</p>
<p>This module contains the major database models of the game
<strong><em> Content </em></strong>
The main database model</p>
<p><strong> Details </strong>
We have the game that extends the user by adding a current level
In addition we do have a set of levels associated to a game</p>
<p>@author: (c) Thomas LÃ¼th 2019 / info@tlc-it-consulting.com</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">transaction</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">post_save</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">gettext_lazy</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">tlu_hardware.tlu_buttons</span> <span class="kn">import</span> <span class="n">tlu_buttons</span>
<span class="kn">from</span> <span class="nn">tlu_hardware.tlu_cursor</span> <span class="kn">import</span> <span class="n">tlu_cursor</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">joy_it_game</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">tlu_services.tlu_processes</span> <span class="kn">import</span> <span class="n">abortProcess</span><span class="p">,</span> <span class="n">startProcess</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">tlu_hardware</span> <span class="kn">import</span> <span class="n">tlu_hardware_global</span>
<span class="kn">from</span> <span class="nn">tlu_hardware.tlu_hardwarebase</span> <span class="kn">import</span> <span class="n">tlu_hardwarebase</span>
<span class="kn">from</span> <span class="nn">tlu_hardware.tlu_touch</span> <span class="kn">import</span> <span class="n">tlu_touch</span>

<span class="n">logfile</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_DIR</span><span class="o">+</span><span class="s2">&quot;/log/game.log&quot;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">log_level</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_LEVEL</span>  <span class="c1"># @UndefinedVariable</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">logfile</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">;</span><span class="si">%(filename)-16.16s</span><span class="s1">;</span><span class="si">%(lineno)04d</span><span class="s1">;</span><span class="si">%(levelname)-8s</span><span class="s1">;</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">()</span>
<span class="n">states</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Class to hold the status of a level played</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">gameState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <pre><code>This class is needed to allow to post the current status on the web. The game provides frequent updates to the state.
These are then taken by the Ajax-call that request updates for the frontend
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">level_progress</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">level_start</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">level_ended</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">points</span><span class="o">=</span><span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Kind of basic initialization</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <pre><code>    This is needed to have a clenan state when a level would be started as the same state would be used
    for all levels for a particular use
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_progress</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_start</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_ended</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="o">=</span><span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Calls cleanup</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Initializes class-object by a recorded state if available
Else calls cleanup
:param user_id: ID to identify the user of the game</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">fromUserId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_id</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">global</span> <span class="n">states</span>
        <span class="n">status_dict</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">status_dict</span><span class="o">=</span><span class="n">states</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">status_dict</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Status read for user-id:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; is:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">user_id</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">=</span><span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;MSG&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_progress</span><span class="o">=</span><span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;LEVEL_PROGRESS&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">=</span><span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;RESULT&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_start</span><span class="o">=</span><span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;LEVEL_START&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_ended</span><span class="o">=</span><span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;LEVEL_ENDED&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="o">=</span><span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;POINTS&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Saves the current state of the game in the global states dictionary
by using the user-id as the key
:param user_id: Key to identify the user</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">saveUserId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_id</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">global</span> <span class="n">states</span>
        <span class="n">status_dict</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;MSG&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span>
        <span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;LEVEL_PROGRESS&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level_progress</span>
        <span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;RESULT&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span>
        <span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;LEVEL_START&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level_start</span>
        <span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;LEVEL_ENDED&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level_ended</span>
        <span class="n">status_dict</span><span class="p">[</span><span class="s1">&#39;POINTS&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span>
        <span class="n">states</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">=</span><span class="n">status_dict</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;status saved for user-id:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; is:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">user_id</span><span class="p">]))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Service to return the gamestate of the user given
:param user_id: Key to identify the state</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getGameState</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gameState</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">state</span><span class="o">=</span><span class="n">gameState</span><span class="p">()</span>
    <span class="n">state</span><span class="o">.</span><span class="n">fromUserId</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">state</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Provides and sets a fresh gameState
:param user_id: Key to identify the state</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getCleanGameState</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gameState</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">state</span><span class="o">=</span><span class="n">gameState</span><span class="p">()</span>
    <span class="n">state</span><span class="o">.</span><span class="n">saveUserId</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">state</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>sets the updated state, service function to wrap the gamestate call
:param user_id: Key to identify the state
:param gamestate: gamestate that should be saved</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">setGameState</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="n">gamestate</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">gamestate</span><span class="o">.</span><span class="n">saveUserId</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Check if user is allowed to play</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">userOk</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <pre><code>The user has to be logged in/authenticated in order to play the levels
:param user_id: The user in question
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span><span class="o">=</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">game</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>retrieve the process by id</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getProcess</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">active_children</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span><span class="n">pid</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Process for pid:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; is:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">p</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Process for pid:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; is:None&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>The Game - Main class</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Game</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <pre><code>Major class to play the game. Controls the Levels, starts and stops the processes
</code></pre>
<p>some constants</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">current_level</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Level&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;active_levels&#39;</span><span class="p">)</span>
    <span class="n">process_pid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>The dipswitch_settings and frequent_updates are required for each level. This is needed
to lookup the correct task and to forward the frequency for the updates on the web (in ms)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">dipswitch_settings</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">frequent_updates</span><span class="o">=</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">250</span><span class="p">,</span><span class="mi">250</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">tlu_hardware_global</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dipswitch_settings</span><span class="o">=</span><span class="p">(</span><span class="n">tlu_hardwarebase</span><span class="o">.</span><span class="n">getDipHex</span><span class="p">(</span><span class="n">tlu_buttons</span><span class="p">),</span>
                                 <span class="n">tlu_hardwarebase</span><span class="o">.</span><span class="n">getDipHex</span><span class="p">(</span><span class="n">tlu_buttons</span><span class="p">),</span>
                                 <span class="n">tlu_hardwarebase</span><span class="o">.</span><span class="n">getDipHex</span><span class="p">(</span><span class="n">tlu_cursor</span><span class="p">),</span>
                                 <span class="n">tlu_hardwarebase</span><span class="o">.</span><span class="n">getDipHex</span><span class="p">(</span><span class="n">tlu_buttons</span><span class="p">),</span>
                                 <span class="n">tlu_hardwarebase</span><span class="o">.</span><span class="n">getDipHex</span><span class="p">(</span><span class="n">tlu_buttons</span><span class="p">)</span><span class="o">|</span><span class="n">tlu_hardwarebase</span><span class="o">.</span><span class="n">getDipHex</span><span class="p">(</span><span class="n">tlu_touch</span><span class="p">))</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">=</span> <span class="s2">&quot;id:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;user:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; lev:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; process-id:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Sets the level of the game
:param level: levelobject to be set</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">setLevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="o">=</span><span class="n">level</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>Returns the current level-object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">getLevel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>Check if the end of the game is reached now.
Returns True if so.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">endReached</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="o">.</span><span class="n">levelnum</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequent_updates</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>Check if the given level-number indicates the end of the game
:param level_num: number to check for end of game</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level_num</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">level_num</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequent_updates</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>Returns the number of miliseconds that we wait until the next Ajax-Call has to be made.
There is one number defined for each level, as each level is different
:param level_num: number of level that has to be examined</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">getFrequentUpdatesMs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level_num</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequent_updates</span><span class="p">[</span><span class="n">level_num</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>Return the hex-code for the 2 dip-switches. Their setting depend on the hardware that would be used for the level.
:param level_num: number of level to request the setting</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">getDipSwitch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level_num</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dipswitch_settings</span><span class="p">[</span><span class="n">level_num</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>Calculate the overall progress in percent of the game based on the current level and current progress</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">getOverallProgress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">state</span><span class="o">=</span><span class="n">getGameState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequent_updates</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="o">.</span><span class="n">levelnum</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">level_progress</span><span class="o">/</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequent_updates</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>Calculate the total number of achieved points by iterating through all successfully passed levels so far</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">getAchievedPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">achievedPoints</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span>
        <span class="k">while</span> <span class="n">level</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">result</span><span class="o">==</span><span class="n">Level</span><span class="o">.</span><span class="n">PASSED</span><span class="p">:</span>
                <span class="n">achievedPoints</span><span class="o">+=</span><span class="n">level</span><span class="o">.</span><span class="n">points</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">prevLevel</span>
        <span class="k">return</span> <span class="n">achievedPoints</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>Internal: Calculate the number of seconds played for the specified level
:param level: The level in scope
:type level: Level object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_seconds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">level_start</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">level_ended</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">level</span><span class="o">.</span><span class="n">level_ended</span><span class="o">-</span><span class="n">level</span><span class="o">.</span><span class="n">level_start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
        <span class="k">return</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>Calculate the number of seconds played for a specified game
:param level: The final level for the game in scope
:type level: Level object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">getSecondsPlayedPerGame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">seconds</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="n">level</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">seconds</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">prevLevel</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>Calculate the number of minutes played on the current game</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">getMinutesPlayedCurrentGame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSecondsPlayedPerGame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>Calculate the number of minutes played in total for the user</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">getMinutesPlayedOverall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">seconds</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">startcounting</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">level_set</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">Level</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
            <span class="n">level_set</span><span class="o">=</span><span class="bp">None</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">level_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">startcounting</span><span class="p">:</span>
                <span class="n">seconds</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSecondsPlayedPerGame</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">prevLevel</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
                <span class="n">startcounting</span><span class="o">=</span><span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">startcounting</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>Calculate the number of games started by this user</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">getNumStarts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">numstarts</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">level_set</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">Level</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">level_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">level</span><span class="o">.</span><span class="n">prevLevel</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
                <span class="n">numstarts</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">numstarts</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>Service wrapper to return the game-state</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">getState</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">state</span><span class="o">=</span><span class="n">getGameState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>Internal method to abort the level played</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_abortTask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <pre><code>    
    :param msg: msg for logging purposes while aborting the process
    :param timeout: time in seconds to wait for a process to abort
</code></pre>
<p>simply aborts a task</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">process</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">process</span><span class="o">=</span><span class="n">getProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_level</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">process</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Aborting task with id &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">ident</span><span class="p">))</span>
            <span class="n">abortProcess</span><span class="p">(</span><span class="n">process</span><span class="p">,</span><span class="n">timeout</span><span class="p">,</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span><span class="o">=</span><span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>Restart the game from scratch at the task provided
:param task: Level that should be used to start the game</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">startFromScratch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">task</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">process</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">process</span><span class="o">=</span><span class="n">getProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span><span class="p">)</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;game start from scratch requested&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gamelevel</span><span class="o">.</span><span class="n">level</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">process</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>Force restart of the game by setting the current level to none</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>Start the game-level</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">task</span><span class="p">,</span><span class="n">level_num</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <pre><code>    
    :param task: the level-process to be played
    :param level_num: the number of the level to be played
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">process</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">process</span><span class="o">=</span><span class="n">getProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;game start requested&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_level</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">process</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
            <span class="n">level</span><span class="o">=</span><span class="n">Level</span><span class="p">()</span>
            <span class="n">level</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">level_num</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="p">)</span>
            <span class="n">level</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="o">=</span><span class="n">level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;This is the game: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">proc</span><span class="o">=</span><span class="n">task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">startProcess</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span><span class="o">=</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Game started:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">proc</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>Internal used method to end the current game-level</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <pre><code>    
    :param msg: debugging message for aborting the game
    :param status: status for the termination, any of the states provided by the Level-class
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">_abortTask</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">gamestate</span><span class="o">=</span><span class="n">getGameState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">==</span><span class="n">Level</span><span class="o">.</span><span class="n">ABORT</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">gamestate</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="n">Level</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <p>abort only if not already stopped</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">gamestate</span><span class="o">.</span><span class="n">result</span><span class="o">=</span><span class="n">Level</span><span class="o">.</span><span class="n">ABORT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gamestate</span><span class="o">.</span><span class="n">result</span><span class="o">=</span><span class="n">status</span>
        <span class="k">if</span> <span class="n">gamestate</span><span class="o">.</span><span class="n">level_ended</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">gamestate</span><span class="o">.</span><span class="n">level_ended</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="c1"># set ending time</span>
        <span class="k">if</span> <span class="n">gamestate</span><span class="o">.</span><span class="n">result</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">gamestate</span><span class="o">.</span><span class="n">result</span><span class="o">=</span><span class="n">Level</span><span class="o">.</span><span class="n">FAILED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="o">.</span><span class="n">setFromGameState</span><span class="p">(</span><span class="n">gamestate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>short for _end with Level.ABORT</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">_end</span><span class="p">(</span><span class="s2">&quot;while aborting&quot;</span><span class="p">,</span> <span class="n">Level</span><span class="o">.</span><span class="n">ABORT</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>Sets result of previous level to retry</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">retry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">process</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">process</span><span class="o">=</span><span class="n">getProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;game retry requested&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_level</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">process</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_abortTask</span><span class="p">(</span><span class="s2">&quot;Aborting to retry&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="o">.</span><span class="n">result</span><span class="o">=</span><span class="n">Level</span><span class="o">.</span><span class="n">RETRY</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_level</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      <p>Wait for the level to end</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      <pre><code>    Wait until task produces a result or timeout(in seconds) runs out
    Retrieves the result of a level
    :param timeout: Seconds to wait b4 terminating the process, default 60 seconds
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;requesting result of level&quot;</span><span class="p">)</span>
        <span class="n">state</span><span class="o">=</span><span class="n">getGameState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">process</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">process</span><span class="o">=</span><span class="n">getProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_level</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">alive</span><span class="o">=</span><span class="bp">False</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
                <span class="n">alive</span><span class="o">=</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;result called, current alive-status of task: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">alive</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; state=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
            <span class="n">count</span><span class="o">=</span><span class="n">timeout</span><span class="o">*</span><span class="mi">10</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">alive</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      <p>wait for task to end</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;current alive-state of task: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())</span><span class="o">+</span><span class="s2">&quot; count=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">process</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
                    <span class="n">alive</span><span class="o">=</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
            <span class="n">state</span><span class="o">=</span><span class="n">getGameState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;result called, updated alive-state of task: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">alive</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; count=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; state=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;result called, but timed-out&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_abortTask</span><span class="p">(</span><span class="s2">&quot;aborting while waiting for result due to timeout&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">state</span><span class="o">.</span><span class="n">result</span><span class="o">=</span><span class="n">Level</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;current state: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
            <span class="n">setGameState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span><span class="o">=</span><span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_end</span><span class="p">(</span><span class="s2">&quot;End requested with state: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">),</span><span class="n">state</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">result</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      <p>Check if Game is running</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">process</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">process</span><span class="o">=</span><span class="n">getProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_pid</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_level</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">process</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Alive-State of &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">ident</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; is:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-75'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-75'>#</a>
      </div>
      <p>The Level played for the game</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_game</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">created</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
        <span class="n">Game</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
        
<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_game</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    
<span class="k">class</span> <span class="nc">Level</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-76'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-76'>#</a>
      </div>
      <pre><code>Defines some constants for the status of the game-level:
*NOT_STARTED=0
*PASSED=1
*RETRY=2
*ABORT=3
*FAILED=4
*STARTED=5

This is also the database representation of the current level.
Forms a daisy-chain by referencing to the previous level, if available
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">NOT_STARTED</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">PASSED</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">RETRY</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">ABORT</span><span class="o">=</span><span class="mi">3</span>
    <span class="n">FAILED</span><span class="o">=</span><span class="mi">4</span>
    <span class="n">STARTED</span><span class="o">=</span><span class="mi">5</span>
    <span class="n">TIMEOUT</span><span class="o">=</span><span class="mi">6</span>
    <span class="n">DIDNOTFINISH</span><span class="o">=</span><span class="mi">6</span>
    <span class="n">resultdict</span><span class="o">=</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;not started&quot;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;retry&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;abort&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;failed&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">),</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;not finished&quot;</span><span class="p">))</span>
    <span class="n">game</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Game</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1">#reference to the underlying game object</span>
    <span class="n">prevLevel</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Level&#39;</span><span class="p">,</span><span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;all_levels&#39;</span><span class="p">)</span> <span class="c1">#daisy-chain for a game consisting of levels</span>
    <span class="n">levelnum</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Level-Number ranging from 00 (Test only), 1..99</span>
    <span class="n">level_start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="c1">#When did the user start this level?</span>
    <span class="n">level_ended</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="c1">#When did it end?</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#achieved points for the level</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#result of level played: NOT_STARTED, PASSED, RETRY, ABORT, FAILED, STARTED</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-77'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-77'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">=</span><span class="s2">&quot;Level: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levelnum</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; points: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; res: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_start</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot; start: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level_start</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level_ended</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot; end: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level_ended</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-78'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-78'>#</a>
      </div>
      <pre><code>   if (self.prevLevel != None):
       ret+=" prev-Level= "+str(self.prevLevel)
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">ret</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-79'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-79'>#</a>
      </div>
      <p>Set some defaults for the level, including the reference to the game</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">game</span><span class="p">):</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">game</span><span class="o">=</span><span class="n">game</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">level</span>
        
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">levelnum</span><span class="p">,</span><span class="n">game</span><span class="p">,</span><span class="n">prevLevel</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-80'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-80'>#</a>
      </div>
      <pre><code>    
    :param levelnum: level number (1..99)
    :param game: reference to the game currently played
    :param prevLevel: reference to previous level, if exist else None (default)
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">prevLevel</span><span class="o">=</span><span class="n">prevLevel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">achieved_points</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">levelnum</span><span class="o">=</span><span class="n">levelnum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_start</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_ended</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">=</span><span class="n">Level</span><span class="o">.</span><span class="n">NOT_STARTED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">=</span><span class="n">game</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-81'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-81'>#</a>
      </div>
      <p>Load Level-status from state-object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">setFromGameState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gameState</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-82'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-82'>#</a>
      </div>
      <pre><code>    As the state object only exists in memory this
    methos persists the state as part of the level-object in the database

    :param gameState: state that has to be persisted
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">level_start</span><span class="o">=</span><span class="n">gameState</span><span class="o">.</span><span class="n">level_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_ended</span><span class="o">=</span><span class="n">gameState</span><span class="o">.</span><span class="n">level_ended</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="o">=</span><span class="n">gameState</span><span class="o">.</span><span class="n">points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">=</span><span class="n">gameState</span><span class="o">.</span><span class="n">result</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-83'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-83'>#</a>
      </div>
      <p>Returns the string representation of the given result
:param result: Number-Code of result of level</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">strFromResult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">result</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-84'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-84'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">result</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;NONE&quot;</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resultdict</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resultdict</span><span class="p">[</span><span class="n">result</span><span class="p">])</span>
        <span class="k">return</span> <span class="s2">&quot;???&quot;</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
